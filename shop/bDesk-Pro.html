<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy bDesk Pro</title>
  <style>
    :root {
      --blue: #0071e3;
      --border: #d2d2d7;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --bg: #fff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: opacity 0.3s ease;
    }

    body.fade-out {
      opacity: 0.5;
    }

    header {
      text-align: center;
      padding: 28px 16px;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    h1 {
      font-size: 1.9rem;
      margin: 0;
      font-weight: 700;
    }

    .models, .configurator, .confirmation {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }
    
    .models {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }
    
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      background: #fff;
      transition: box-shadow .15s, transform .06s;
      display: flex;
      flex-direction: column;
    }
    
    .card:hover {
      border-color: var(--blue);
      transform: translateY(-2px);
    }
    
    .card-content {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .card-image {
      width: 140px;
      height: 140px;
      border-radius: 8px;
      overflow: hidden;
      background: #f5f5f7;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .card-image img {
      max-width: 100%;
      max-height: 100%;
      transition: opacity 0.3s ease;
    }
    
    .card-details {
      flex: 1;
    }
    
    .card h2 {
      font-size: 1.3rem;
      margin: 0 0 6px;
      font-weight: 600;
    }
    
    .price {
      font-size: 1.05rem;
      font-weight: 500;
      margin: 6px 0 12px;
      color: var(--muted);
    }
    
    .card ul {
      margin: 0;
      padding-left: 20px;
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .select-btn {
      margin-top: auto;
      padding: 10px 0;
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    
    .select-btn:hover {
      background: #005bb5;
    }

    .back-btn {
      margin: 10px 0 20px;
      padding: 8px 18px;
      background: #f5f5f7;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    
    .back-btn:hover { 
      background: #e6e6e9; 
    }

    .hero { 
      margin-bottom: 24px; 
    }
    
    .hero-title {
      font-size: clamp(1.8rem, 4vw, 2.4rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
      margin: 0 0 12px;
    }
    
    .hero-content {
      display: flex;
      gap: 30px;
      align-items: flex-start;
    }
    
    .hero-image {
      width: 280px;
      flex-shrink: 0;
      border-radius: 0;
      overflow: hidden;
    }
    
    .hero-image img {
      width: 100%;
      display: block;
      transition: opacity 0.3s ease;
    }
    
    .hero-list {
      list-style: none;
      padding: 0;
      margin: 0;
      color: var(--muted);
      flex: 1;
    }
    
    .hero-list li {
      font-size: 1rem;
      line-height: 1.6;
      margin: 6px 0;
    }

    .group { 
      margin: 24px 0; 
      position: relative;
    }
    
    .group h3 {
      font-size: 1.1rem;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--muted);
      color: white;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .info-icon:hover {
      background: var(--blue);
    }

    .pill {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 28px 20px;
      border: 1px solid var(--border);
      border-radius: 12px;
      margin: 10px 0;
      cursor: pointer;
      background: #fff;
      transition: border-color .12s, box-shadow .12s, transform .06s;
    }
    
    .pill:hover { 
      border-color: var(--blue); 
      transform: translateY(-2px); 
    }
    
    .pill.selected {
      border: 2px solid var(--blue);
      box-shadow: 0 4px 14px rgba(0,113,227,0.08);
    }
    
    .pill.disabled {
      opacity: .6;
      cursor: not-allowed;
      background: #fbfbfb;
    }
    
    .pill .label { 
      font-weight: 600; 
    }
    
    .pill .price-right { 
      color: var(--muted); 
      font-weight: 600; 
      white-space: nowrap; 
    }

    .note {
      font-size: .9rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal-overlay.visible .modal {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      font-size: 1.4rem;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
    }
    
    .modal-content {
      line-height: 1.6;
    }
    
    .modal-content p {
      margin: 0 0 16px;
    }
    
    .modal-content ul {
      margin: 0 0 16px;
      padding-left: 20px;
    }

    .checkout {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      width: auto;
      max-width: 100vw;
      box-sizing: border-box;
      background: #fff;
      border-top: 1px solid var(--border);
      padding: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      z-index: 100;
      overflow-x: hidden;
    }
    
    .total {
      font-size: 1.4rem;
      font-weight: 700;
    }
    
    .add-to-bag {
      padding: 12px 22px;
      font-size: 1.05rem;
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: background .2s;
    }
    
    .add-to-bag:hover { 
      background: #005bb5; 
    }

    .confirmation {
      text-align: center;
      display: none;
    }
    
    .confirmation-image {
      width: 300px;
      margin: 0 auto 20px;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .confirmation-image img {
      width: 100%;
    }
    
    .confirmation-details {
      max-width: 600px;
      margin: 0 auto;
      text-align: left;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 12px;
    }
    
    .confirmation-title {
      font-size: 2.2rem;
      margin-bottom: 10px;
      color: #0071e3;
    }
    
    .confirmation-model {
      font-size: 1.4rem;
      margin-bottom: 20px;
    }
    
    .confirmation-list {
      list-style: none;
      padding: 0;
      margin: 0 0 20px;
    }
    
    .confirmation-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .confirmation-total {
      font-size: 1.6rem;
      font-weight: 700;
      text-align: center;
      margin-top: 20px;
    }

    @media (max-width: 900px) {
      .models {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
      
      .hero-content {
        flex-direction: column;
      }
      
      .hero-image {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
      }
    }

    @media (max-width: 600px) {
      .pill { 
        padding: 14px; 
      }
      
      .checkout {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      
      .add-to-bag { 
        width: 100%; 
      }
      
      .card-content {
        flex-direction: column;
      }
      
      .card-image {
        width: 100%;
        height: 180px;
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="headerTitle">Buy bDesk Pro</h1>
  </header>

  <main>
    <div class="models" id="models"><!-- cards inserted by JS --></div>

    <div class="configurator" id="configurator" style="display:none;">
      <button class="back-btn" id="backBtn">‚Üê Back</button>
      <div class="hero">
        <h2 class="hero-title" id="heroTitle"></h2>
        <div class="hero-content">
          <div class="hero-image" id="heroImage"></div>
          <ul class="hero-list" id="heroList"></ul>
        </div>
      </div>
      <div id="options"></div>
    </div>

    <div class="confirmation" id="confirmation">
      <h2 class="confirmation-title">Order Confirmed!</h2>
      <div class="confirmation-image" id="confirmationImage"></div>
      <h3 class="confirmation-model" id="confirmationModel"></h3>
      <div class="confirmation-details">
        <h4>Order Summary:</h4>
        <ul class="confirmation-list" id="confirmationList"></ul>
        <div class="confirmation-total" id="confirmationTotal"></div>
      </div>
      <button class="back-btn" id="confirmationBackBtn" style="margin-top: 30px;">‚Üê Back to Store</button>
    </div>
  </main>

  <div class="modal-overlay" id="memoryModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="memoryModalTitle">Memory Guide</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-content" id="memoryModalContent">
        <!-- Content will be populated by JS -->
      </div>
    </div>
  </div>

  <div class="checkout" id="checkout">
    <div class="total" id="finalPrice">Total: $0</div>
    <button class="add-to-bag" id="addToBagBtn">Add to Bag</button>
  </div>

  <script>
    (function () {
      const colors = ['Space Grey']; // Only Space Grey available for bDesk Pro
      let selectedColor = 'Space Grey';

      const template = {
        "B5 Ultra": {
          price: 9199,
          display: "30-inch 5.5K Mini-LED display",
          ports: [
            "6 Thunderbolt 5 (USB Type-C) ports",
            "4 USB 3 (Type-A) ports",
            "Headphone Jack",
            "Gigabit Ethernet"
          ],
          upgrades: {
            display: ["30-inch 5.5K Mini-LED display (base)"],
            chip: ["Boiby B5 Ultra chip with 28-core CPU and 76-core GPU (base)", "Boiby B5 Ultra chip with 36-core CPU and 96-core GPU (+$1600)"],
            memory: ["96 GB unified memory (base)", "128 GB unified memory (+$800)", "256 GB unified memory (+$2000)", "512 GB unified memory (+$4200)"],
            storage: ["1 TB SSD storage (base)", "2 TB SSD storage (+$100)", "4 TB SSD storage (+$300)", "8 TB SSD storage (+$700)", "12 TB SSD storage (+$1500)"],
            ethernet: ["Gigabit Ethernet (base)", "2.5 Gigabit Ethernet (+$50)"],
            coating: ["No anti-reflective coating (base)", "Anti-reflective coating (+$150)"],
            keyboard: ["Pro Keyboard with Touch ID (base)", "Pro Keyboard with Touch ID + Numpad (+$50)"],
            mouse: ["Pro Mouse (base)", "Pro Trackpad + Pro Mouse (+$50)"]
          }
        },
        "B5 Max": {
          price: 5699,
          display: "30-inch 5.5K Mini-LED display",
          ports: [
            "6 Thunderbolt 5 (USB Type-C) ports",
            "4 USB 3 (Type-A) ports",
            "Headphone Jack",
            "Gigabit Ethernet"
          ],
          upgrades: {
            display: ["30-inch 5.5K Mini-LED display (base)"],
            chip: ["Boiby B5 Max chip with 14-core CPU and 38-core GPU (base)", "Boiby B5 Max chip with 18-core CPU and 48-core GPU (+$800)"],
            memory: ["48 GB unified memory (base)", "64 GB unified memory (+$200)", "96 GB unified memory (+$400)", "128 GB unified memory (+$700)"],
            storage: ["1 TB SSD storage (base)", "2 TB SSD storage (+$100)", "4 TB SSD storage (+$300)", "8 TB SSD storage (+$700)", "12 TB SSD storage (+$1500)"],
            ethernet: ["Gigabit Ethernet (base)", "2.5 Gigabit Ethernet (+$50)"],
            coating: ["No anti-reflective coating (base)", "Anti-reflective coating (+$150)"],
            keyboard: ["Pro Keyboard with Touch ID (base)", "Pro Keyboard with Touch ID + Numpad (+$50)"],
            mouse: ["Pro Mouse (base)", "Pro Trackpad + Pro Mouse (+$50)"]
          }
        }
      };

      const baseConfigs = JSON.parse(JSON.stringify(template));

      // Memory guide content for different models
      const memoryGuides = {
        'B5 Ultra': `
          <p><strong>How much memory is right for you?</strong></p>
          <p>Our unified memory architecture allows the CPU and GPU to access the same memory pool, improving performance and efficiency. Here is a general guide to how much you might need:</p>
          
          <p><strong>96 GB:</strong> Ideal for professionals with extremely demanding workflows. Perfect for 8K video editing, complex 3D rendering, large-scale machine learning projects, and running multiple virtual machines simultaneously.</p>
          
          <p><strong>128 GB:</strong> Best for specialized professionals working on the most demanding projects. Suitable for high-end visual effects work, scientific simulations, and large-scale data analysis that requires keeping massive datasets in memory.</p>
          
          <p><strong>256 GB or more:</strong> For the most extreme workloads in fields like film production, scientific research, and enterprise-level applications. Designed for workflows that involve enormous projects and require huge amounts of data to be kept in active memory.</p>
          
          <p><strong>Note:</strong> The 36-core CPU and 96-core GPU upgrade unlocks access to 128 GB and 512 GB memory configurations.</p>
        `,
        'B5 Max': `
          <p><strong>How much memory is right for you?</strong></p>
          <p>Our unified memory architecture allows the CPU and GPU to access the same memory pool, improving performance and efficiency. Here is a general guide to how much you might need:</p>
          
          <p><strong>48 GB or 64 GB:</strong> Best for professionals who have highly memory-intensive workflows. Ideal for multi-layer 4K video editing, multiple virtual machines, compiling very large projects, working with complex 3D models and animations, running simulations, moderate machine learning workloads, or playing highly memory-intensive simulator games.</p>
          
          <p><strong>96 GB or more:</strong> For professionals in specialized fields like high-budget film editing, data science, engineering, or machine learning. Designed for workflows that involve enormous projects and require huge amounts of data to be kept in active memory. It is perfect for those working on high-resolution visual effects in cinema, simulation-based software, or advanced scientific computations.</p>
        `
      };

      let selectedModel = null;
      let selectedOptions = {};

      const $ = q => document.querySelector(q);
      const $$ = q => Array.from(document.querySelectorAll(q));
      const cleanLabel = opt => (opt||'').split("(")[0].trim();
      const priceDelta = opt => {
        if (!opt) return 0;
        const m = opt.match(/\+\$(\d+)/);
        return m ? parseInt(m[1],10) : 0;
      };
      const formatPrice = n => `$${n.toLocaleString('en-US')}`;

      function renderModels() {
        const container = $('#models');
        if (!container) return;
        container.innerHTML = '';
        const configs = baseConfigs;
        Object.keys(configs).forEach(model => {
          const cfg = configs[model];
          const card = document.createElement('div');
          card.className = 'card';
          card.setAttribute('data-model', model);
          
          // Create image element
          const imageUrl = `bDeskProSpaceGrey.png`;
          
          card.innerHTML = `
            <div class="card-content">
              <div class="card-image">
                <img src="${imageUrl}" alt="${model} ${selectedColor}" id="card-image-${model.replace(/\s+/g, '-')}">
              </div>
              <div class="card-details">
                <h2>bDesk Pro - ${model}</h2>
                <p class="price">From ${formatPrice(cfg.price)}</p>
                <ul>
                  <li>${cfg.display}</li>
                  <li>${cleanLabel(cfg.upgrades.chip[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.memory[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.storage[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.ethernet[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.coating[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.keyboard[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.mouse[0])}</li>
                </ul>
                <p><strong>Ports:</strong></p>
                <ul>
                  ${cfg.ports.map(port => `<li>${port}</li>`).join('')}
                </ul>
              </div>
            </div>
            <button class="select-btn" data-model="${model}">Select</button>
          `;
          
          // Add select button event
          card.querySelector('.select-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const model = e.target.getAttribute('data-model');
            selectedModel = model;
            
            const modelsEl = $('#models');
            if (modelsEl) modelsEl.style.display = 'none';
            $('#configurator').style.display = 'block';
            showConfigurator();
          });
          
          container.appendChild(card);
        });
      }

      function showConfigurator() {
        const cfg = baseConfigs[selectedModel];
        const optionsDiv = $('#options');
        optionsDiv.innerHTML = '';
        selectedOptions = {};

        $('#heroTitle').innerText = `Customise your bDesk Pro ‚Äî ${selectedModel}`;
        
        // Update hero image
        const heroImage = $('#heroImage');
        heroImage.innerHTML = `<img src="bDeskProSpaceGrey.png" alt="${selectedModel} ${selectedColor}">`;

        // upgrades
        Object.keys(cfg.upgrades).forEach(category => {
          const group = document.createElement('div');
          group.className = 'group';
          const h3 = document.createElement('h3');
          
          // Add info icon for memory category
          if (category === 'memory') {
            h3.innerHTML = `Memory <span class="info-icon" data-category="memory">?</span>`;
          } else {
            h3.innerText = category.charAt(0).toUpperCase() + category.slice(1);
          }
          
          group.appendChild(h3);

          cfg.upgrades[category].forEach((opt, idx) => {
            const pill = document.createElement('div');
            pill.className = 'pill';
            pill.dataset.cat = category;
            pill.dataset.value = opt;
            pill.innerHTML = `<span class="label">${cleanLabel(opt)}</span><span class="price-right">${priceDelta(opt) ? ('+$' + priceDelta(opt)) : ''}</span>`;

            pill.addEventListener('click', () => {
              if (pill.classList.contains('disabled')) return;
              // single-select logic
              Array.from(group.querySelectorAll('.pill')).forEach(s => s.classList.remove('selected'));
              pill.classList.add('selected');
              selectedOptions[category] = pill.dataset.value;
              if (category === 'chip') handleDependencies(); // re-evaluate when chip changes
              renderHeroSummary();
              updatePrice();
            });

            // Default selection logic
            if (idx === 0) {
              pill.classList.add('selected');
              selectedOptions[category] = pill.dataset.value;
            }

            group.appendChild(pill);
          });

          if (category === 'memory') {
            const note = document.createElement('div');
            note.className = 'note';
            note.innerText = 'Higher memory options require higher-end CPU/GPU selections.';
            group.appendChild(note);
            
            // Add event listener to the info icon
            const infoIcon = h3.querySelector('.info-icon');
            if (infoIcon) {
              infoIcon.addEventListener('click', () => showMemoryModal(selectedModel));
            }
          }

          optionsDiv.appendChild(group);
        });

        // Apply dependency logic
        handleDependencies();
        renderHeroSummary();
        updatePrice();
      }

      function handleDependencies() {
        if (!selectedModel) return;

        const cfg = baseConfigs[selectedModel];
        const optionsDiv = $('#options');
        if (!optionsDiv) return;

        const chipFull = selectedOptions.chip || cfg.upgrades.chip[0];
        console.log('Selected model:', selectedModel);
        console.log('Selected chip:', chipFull);

        // Select all memory pills directly using data-cat="memory"
        const memoryPills = Array.from(document.querySelectorAll('.pill[data-cat="memory"]'));
        if (!memoryPills.length) {
            console.warn('No memory pills found');
            return;
        }

        // Helper to get clean text for a pill
        const getPillText = (pill) => {
            const label = pill.querySelector('.label');
            return (label ? label.textContent : pill.textContent).trim();
        }

        // Helper to find a pill by text
        const findPill = (text) => memoryPills.find(p => getPillText(p).includes(text));

        // Remove all disabled classes first
        memoryPills.forEach(p => p.classList.remove('disabled'));

        // --- Handle dependencies based on model ---
        if (selectedModel === 'B5 Ultra') {
            const mem128 = findPill('128 GB');
            const mem256 = findPill('256 GB');
            const mem512 = findPill('512 GB');


            // 128GB and 256GB require 36-core CPU + 96-core GPU
            if (chipFull.includes('36-core') && chipFull.includes('96-core')) {
                console.log('128GB and 256GB memory enabled for B5 Ultra');
                if (mem128) mem128.classList.remove('disabled');
                if (mem256) mem256.classList.remove('disabled');
                if (mem512) mem512.classList.remove('disabled');
            } else {
                console.log('128GB and 256GB memory disabled for B5 Ultra');
                if (mem128) mem128.classList.remove('disabled');
                if (mem256) mem256.classList.remove('disabled');
                if (mem512) mem512.classList.add('disabled');

                // Auto-select first available memory if current selection is disabled
                if (selectedOptions.memory && (selectedOptions.memory.includes('128 GB') || selectedOptions.memory.includes('256 GB'))) {
                    memoryPills.forEach(p => p.classList.remove('selected'));
                    const firstAvailable = memoryPills.find(p => !p.classList.contains('disabled'));
                    if (firstAvailable) {
                        firstAvailable.classList.add('selected');
                        selectedOptions.memory = cfg.upgrades.memory.find(m => 
                            m.includes(getPillText(firstAvailable))
                        );
                        console.log('Memory auto-selected:', selectedOptions.memory);
                    }
                }
            }
        } else if (selectedModel === 'B5 Max') {
            const mem64 = findPill('64 GB');
            const mem96 = findPill('96 GB');
            const mem128 = findPill('128 GB');

            // 64GB & 128GB require 18-core CPU + 48-core GPU
            if (chipFull.includes('18-core') && chipFull.includes('48-core')) {
                if (mem64) mem64.classList.remove('disabled');
                if (mem128) mem128.classList.remove('disabled');
                console.log('64GB, 128GB memory enabled for B5 Max');
            } else {
                if (mem64) mem64.classList.add('disabled');
                if (mem128) mem128.classList.add('disabled');
                console.log('64GB, 128GB memory disabled for B5 Max');

                if (selectedOptions.memory && (selectedOptions.memory.includes('64 GB') || selectedOptions.memory.includes('128 GB')|| selectedOptions.memory.includes('256 GB'))) {
                    memoryPills.forEach(p => p.classList.remove('selected'));
                    const firstAvailable = memoryPills.find(p => !p.classList.contains('disabled'));
                    if (firstAvailable) {
                        firstAvailable.classList.add('selected');
                        selectedOptions.memory = cfg.upgrades.memory.find(m => 
                            m.includes(getPillText(firstAvailable))
                        );
                        console.log('Memory auto-selected:', selectedOptions.memory);
                    }
                }
            }

            // 96GB requires 14-core CPU + 38-core GPU
            if (chipFull.includes('14-core') && chipFull.includes('38-core')) {
                if (mem96) mem96.classList.remove('disabled');
                console.log('96GB memory enabled for B5 Max');
            } else {
                if (mem96) mem96.classList.add('disabled');
                console.log('96GB memory disabled for B5 Max');

                if (selectedOptions.memory && selectedOptions.memory.includes('96 GB')) {
                    memoryPills.forEach(p => p.classList.remove('selected'));
                    const firstAvailable = memoryPills.find(p => !p.classList.contains('disabled'));
                    if (firstAvailable) {
                        firstAvailable.classList.add('selected');
                        selectedOptions.memory = cfg.upgrades.memory.find(m => 
                            m.includes(getPillText(firstAvailable))
                        );
                        console.log('Memory auto-selected:', selectedOptions.memory);
                    }
                }
            }
        }

        renderHeroSummary();
        updatePrice();
      }

      function showMemoryModal(model) {
        const modal = $('#memoryModal');
        const title = $('#memoryModalTitle');
        const content = $('#memoryModalContent');
        
        // Set title and content based on model
        title.textContent = `${model} Memory Guide`;
        content.innerHTML = memoryGuides[model] || memoryGuides['B5 Max'];
        
        modal.classList.add('visible');
        
        // Add event listener to close button
        const closeButton = modal.querySelector('.modal-close');
        closeButton.addEventListener('click', hideMemoryModal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            hideMemoryModal();
          }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            hideMemoryModal();
            document.removeEventListener('keydown', escHandler);
          }
        });
      }
      
      function hideMemoryModal() {
        const modal = $('#memoryModal');
        modal.classList.remove('visible');
      }

      function renderHeroSummary() {
        const list = $('#heroList');
        if (!list) return;
        list.innerHTML = '';
        const cfg = baseConfigs[selectedModel];
        list.appendChild(li(`bDesk Pro ‚Äî ${selectedModel}`));
        list.appendChild(li(`Color: ${selectedColor}`));
        
        // Add ports information
        list.appendChild(li("Ports:"));
        cfg.ports.forEach(port => {
          list.appendChild(li(`‚Ä¢ ${port}`));
        });
        
        const order = ['display', 'chip', 'memory', 'storage', 'ethernet', 'coating', 'keyboard', 'mouse'];
        order.forEach(cat => {
          if (selectedOptions[cat]) list.appendChild(li(cleanLabel(selectedOptions[cat])));
        });
      }

      function updatePrice() {
        const cfg = baseConfigs[selectedModel];
        let price = cfg.price;
        Object.keys(selectedOptions).forEach(cat => {
          price += priceDelta(selectedOptions[cat]);
        });
        $('#finalPrice').innerText = `Total: ${formatPrice(price)}`;
      }

      function showConfirmation() {
        const cfg = baseConfigs[selectedModel];
        let price = cfg.price;
        
        // Hide configurator and checkout, show confirmation
        $('#configurator').style.display = 'none';
        $('#checkout').style.display = 'none';
        $('#confirmation').style.display = 'block';
        
        // Set confirmation image
        $('#confirmationImage').innerHTML = `<img src="bDeskProSpaceGrey.png" alt="${selectedModel} ${selectedColor}">`;
        
        // Set confirmation model text
        $('#confirmationModel').textContent = `bDesk Pro - ${selectedModel} - ${selectedColor}`;
        
        // Build confirmation list
        const list = $('#confirmationList');
        list.innerHTML = '';
        
        list.appendChild(li(`Model: bDesk Pro - ${selectedModel}`));
        list.appendChild(li(`Color: ${selectedColor}`));
        list.appendChild(li(cleanLabel(selectedOptions.display || cfg.upgrades.display[0])));
        list.appendChild(li(cleanLabel(selectedOptions.chip || cfg.upgrades.chip[0])));
        list.appendChild(li(cleanLabel(selectedOptions.memory || cfg.upgrades.memory[0])));
        list.appendChild(li(cleanLabel(selectedOptions.storage || cfg.upgrades.storage[0])));
        list.appendChild(li(cleanLabel(selectedOptions.ethernet || cfg.upgrades.ethernet[0])));
        list.appendChild(li(cleanLabel(selectedOptions.coating || cfg.upgrades.coating[0])));
        list.appendChild(li(cleanLabel(selectedOptions.keyboard || cfg.upgrades.keyboard[0])));
        list.appendChild(li(cleanLabel(selectedOptions.mouse || cfg.upgrades.mouse[0])));
        
        // Calculate final price
        Object.keys(selectedOptions).forEach(cat => {
          price += priceDelta(selectedOptions[cat]);
        });
        
        $('#confirmationTotal').textContent = `Total: ${formatPrice(price)}`;
      }

      function li(text) { 
        const el = document.createElement('li'); 
        el.textContent = text; 
        return el; 
      }

      const backBtn = $('#backBtn');
      if (backBtn) backBtn.addEventListener('click', () => {
        $('#configurator').style.display = 'none';
        $('#models').style.display = 'grid';
      });

      const confirmationBackBtn = $('#confirmationBackBtn');
      if (confirmationBackBtn) confirmationBackBtn.addEventListener('click', () => {
        $('#confirmation').style.display = 'none';
        $('#models').style.display = 'grid';
        $('#checkout').style.display = 'flex';
      });

      const addToBagBtn = $('#addToBagBtn');
      if (addToBagBtn) addToBagBtn.addEventListener('click', showConfirmation);

      document.addEventListener('DOMContentLoaded', () => {
        renderModels();
      });

    })();
  </script>
</body>
</html>

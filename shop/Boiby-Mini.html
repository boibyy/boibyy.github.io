<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buy Boiby Mini</title>
  <style>
    :root {
      --blue: #0071e3;
      --border: #d2d2d7;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --bg: #fff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      transition: opacity 0.3s ease;
    }

    body.fade-out {
      opacity: 0.5;
    }

    header {
      text-align: center;
      padding: 28px 16px;
      border-bottom: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    h1 {
      font-size: 2rem;
      font-weight: 600;
      margin: 0;
    }

    .models {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
    }
    
    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      background: #fff;
      transition: box-shadow .15s, transform .06s;
      display: flex;
      flex-direction: column;
    }
    
    .card:hover {
      border-color: var(--blue);
      transform: translateY(-2px);
    }
    
    .card-content {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .card-image {
      width: 140px;
      height: 140px;
      border-radius: 0px;
      overflow: hidden;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .card-image img {
      max-width: 100%;
      max-height: 100%;
      transition: opacity 0.3s ease;
    }
    
    .card-details {
      flex: 1;
    }
    
    .card h2 {
      font-size: 1.3rem;
      margin: 0 0 6px;
      font-weight: 600;
    }
    
    .price {
      font-size: 1.05rem;
      font-weight: 500;
      margin: 6px 0 12px;
      color: var(--muted);
    }
    
    .card ul {
      margin: 0;
      padding-left: 20px;
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .color-display {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 0.9rem;
      margin: 10px 0;
      text-align: center;
      background: #f9f9f9;
    }
    
    .select-btn {
      margin-top: auto;
      padding: 10px 0;
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    
    .select-btn:hover {
      background: #005bB5;
    }

    .back-btn {
      margin: 10px 0 20px;
      padding: 8px 18px;
      background: #f5f5f7;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    
    .back-btn:hover { 
      background: #e6e6e9; 
    }

    .hero { 
      margin-bottom: 24px; 
    }
    
    .hero-title {
      font-size: clamp(1.8rem, 4vw, 2.4rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
      margin: 0 0 12px;
    }
    
    .hero-content {
      display: flex;
      gap: 30px;
      align-items: flex-start;
    }
    
    .hero-image {
      width: 280px;
      flex-shrink: 0;
      border-radius: 0px;
      overflow: hidden;
      background: #fff;
    }
    
    .hero-image img {
      width: 100%;
      display: block;
      transition: opacity 0.3s ease;
    }
    
    .hero-list {
      list-style: none;
      padding: 0;
      margin: 0;
      color: var(--muted);
      flex: 1;
    }
    
    .hero-list li {
      font-size: 1rem;
      line-height: 1.6;
      margin: 6px 0;
    }

    .group { 
      margin: 24px 0; 
      position: relative;
    }
    
    .group h3 {
      font-size: 1.1rem;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--muted);
      color: white;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .info-icon:hover {
      background: var(--blue);
    }

    .chip-info-link {
      text-align: center;
      margin: 30px 0 20px;
    }
    
    .chip-info-link a {
      color: var(--blue);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }
    
    .chip-info-link a:hover {
      text-decoration: underline;
    }

    .pill {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 28px 20px;
      border: 1px solid var(--border);
      border-radius: 12px;
      margin: 10px 0;
      cursor: pointer;
      background: #fff;
      transition: border-color .12s, box-shadow .12s, transform .06s;
    }
    
    .pill:hover { 
      border-color: var(--blue); 
      transform: translateY(-2px); 
    }
    
    .pill.selected {
      border: 2px solid var(--blue);
      box-shadow: 0 4px 14px rgba(0,113,227,0.08);
    }
    
    .pill.disabled {
      opacity: .6;
      cursor: not-allowed;
      background: #fbfbfb;
    }
    
    .pill .label { 
      font-weight: 600; 
    }
    
    .pill .price-right { 
      color: var(--muted); 
      font-weight: 600; 
      white-space: nowrap; 
    }

    .note {
      font-size: .9rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal-overlay.visible .modal {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      font-size: 1.4rem;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
    }
    
    .modal-content {
      line-height: 1.6;
    }
    
    .modal-content p {
      margin: 0 0 16px;
    }
    
    .modal-content ul {
      margin: 0 0 16px;
      padding-left: 20px;
    }

    .chip-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin: 20px 0;
    }
    
    .chip-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .chip-card h4 {
      margin: 0 0 10px;
      font-size: 1.1rem;
      color: var(--blue);
    }
    
    .chip-card ul {
      text-align: left;
      margin: 0;
      padding-left: 20px;
      font-size: 0.9rem;
    }
    
    .chip-specs {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .checkout {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      width: auto;
      max-width: 100vw;
      box-sizing: border-box;
      background: #fff;
      border-top: 1px solid var(--border);
      padding: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      z-index: 100;
      overflow-x: hidden;
      padding-left: max(18px, env(safe-area-inset-left));
      padding-right: max(18px, env(safe-area-inset-right));
    }
    
    .total {
      font-size: 1.4rem;
      font-weight: 700;
    }
    
    .add-to-bag {
      padding: 12px 22px;
      font-size: 1.05rem;
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: background .2s;
    }
    
    .add-to-bag:hover { 
      background: #005bB5; 
    }

    .confirmation {
      text-align: center;
      display: none;
    }
    
    .confirmation-image {
      width: 300px;
      margin: 0 auto 20px;
      border-radius: 0px;
      overflow: hidden;
    }
    
    .confirmation-image img {
      width: 100%;
    }
    
    .confirmation-details {
      max-width: 600px;
      margin: 0 auto;
      text-align: left;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 12px;
    }
    
    .confirmation-title {
      font-size: 2.2rem;
      margin-bottom: 10px;
      color: #0071e3;
    }
    
    .confirmation-model {
      font-size: 1.4rem;
      margin-bottom: 20px;
    }
    
    .confirmation-list {
      list-style: none;
      padding: 0;
      margin: 0 0 20px;
    }
    
    .confirmation-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .confirmation-total {
      font-size: 1.6rem;
      font-weight: 700;
      text-align: center;
      margin-top: 20px;
    }

    @media (max-width: 900px) {
      .models {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
      
      .hero-content {
        flex-direction: column;
      }
      
      .hero-image {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
      }
      
      .chip-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .pill { 
        padding: 14px; 
      }
      
      .checkout {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      
      .add-to-bag { 
        width: 100%; 
      }
      
      .card-content {
        flex-direction: column;
      }
      
      .card-image {
        width: 100%;
        height: 180px;
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="headerTitle">Buy Boiby Mini</h1>
  </header>

  <main>
    <div class="models" id="models"><!-- cards inserted by JS --></div>

    <div class="chip-info-link">
      <a id="chipInfoLink">What chip do I need? →</a>
    </div>

    <div class="configurator" id="configurator" style="display:none;">
      <button class="back-btn" id="backBtn">← Back</button>
      <div class="hero">
        <h2 class="hero-title" id="heroTitle"></h2>
        <div class="hero-content">
          <div class="hero-image" id="heroImage"></div>
          <ul class="hero-list" id="heroList"></ul>
        </div>
      </div>
      <div id="options"></div>
    </div>

    <div class="confirmation" id="confirmation">
      <h2 class="confirmation-title">Order Confirmed</h2>
      <div class="confirmation-image" id="confirmationImage"></div>
      <h3 class="confirmation-model" id="confirmationModel"></h3>
      <div class="confirmation-details">
        <h4>Order Summary:</h4>
        <ul class="confirmation-list" id="confirmationList"></ul>
        <div class="confirmation-total" id="confirmationTotal"></div>
      </div>
      <button class="back-btn" id="confirmationBackBtn" style="margin-top: 30px;">Back to Store</button>
    </div>
  </main>

  <!-- Memory Modal -->
  <div class="modal-overlay" id="memoryModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="memoryModalTitle">Memory Guide</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-content" id="memoryModalContent">
        <!-- Content will be dynamically inserted based on model -->
      </div>
    </div>
  </div>

  <!-- Chip Info Modal -->
  <div class="modal-overlay" id="chipModal">
    <div class="modal" style="max-width:700px">
      <div class="modal-header">
        <h3 class="modal-title">Which Chip is Right for You?</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-content">
        <p>Our chips are designed for different types of users and workloads. Here's a guide to help you choose:</p>
        
        <div class="chip-grid">
          <div class="chip-card">
            <h4>Boiby B5</h4>
            <ul>
              <li>Perfect for everyday computing, home office tasks, and media consumption</li>
              <li>Handles web browsing, document editing, and light photo editing</li>
              <li>Supports multiple displays for productivity</li>
            </ul>
            <div class="chip-specs">
              <p><strong>Up to:</strong><br>
              10-core CPU<br>
              12-core GPU<br>
              32GB unified memory</p>
              <p>Up to two 4K external displays</p>
            </div>
          </div>
          
          <div class="chip-card">
            <h4>Boiby B5 Pro</h4>
            <ul>
              <li>For power users and creative professionals</li>
              <li>Handles video editing, 3D rendering, and software development</li>
              <li>Perfect for running multiple professional applications simultaneously</li>
            </ul>
            <div class="chip-specs">
              <p><strong>Up to:</strong><br>
              14-core CPU<br>
              24-core GPU<br>
              64GB unified memory</p>
              <p>Up to three 4K external displays</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="checkout" id="checkout">
    <div class="total" id="finalPrice">Total: A$0</div>
    <button class="add-to-bag" id="addToBagBtn">Add to Bag</button>
  </div>

  <script>
    (function () {
      const colors = ['Silver'];
      let selectedColor = 'Silver';

      const template = {
        "B5": {
          price: 999,
          ports: [
            "Back: Three Thunderbolt 4 (USB-C) ports",
            "Back: One USB 3 (Type-A) port",
            "Back: Gigabit Ethernet",
            "Back: HDMI 2.1 port",
            "Back: Audio Jack",
            "Front: Two USB 3 (Type-C) ports"
          ],
          upgrades: {
            chip: ["Boiby B5 chip with 9-core CPU and 10-core GPU (base)", "Boiby B5 chip with 10-core CPU and 12-core GPU (+A$100)"],
            memory: ["16 GB unified memory (base)", "24 GB unified memory (+A$100)", "32 GB unified memory (+A$200)"],
            storage: ["512 GB SSD storage (base)", "1 TB SSD storage (+A$100)", "2 TB SSD storage (+A$200)", "4 TB SSD storage (+A$400)"],
            ethernet: ["Gigabit Ethernet (base)", "10 Gigabit Ethernet (+A$50)"]
          }
        },
        "B5 Pro": {
          price: 1899,
          ports: [
            "Back: Three Thunderbolt 5 (USB-C) ports",
            "Back: One USB 3 (Type-A) port",
            "Back: 10 Gigabit Ethernet",
            "Back: HDMI 2.1 port",
            "Back: Audio Jack",
            "Front: Two Thunderbolt 5 (USB-C) ports"
          ],
          upgrades: {
            chip: ["Boiby B5 Pro chip with 12-core CPU and 19-core GPU (base)", "Boiby B5 Pro chip with 14-core CPU and 24-core GPU (+A$400)"],
            memory: ["24 GB unified memory (base)", "48 GB unified memory (+A$200)", "64 GB unified memory (+A$300)"],
            storage: ["1 TB SSD storage (base)", "2 TB SSD storage (+A$100)", "4 TB SSD storage (+A$300)", "8 TB SSD storage (+A$700)"]
          }
        }
      };

      const baseConfigs = JSON.parse(JSON.stringify(template));

      const addons = {
        accessories: ["Boiby Magic Mouse (+A$100)", "Boiby Magic Keyboard (+A$150)", "Boiby Magic Trackpad (+A$150)"],
        monitor: ["Boiby Studio Display (27-inch 5K) (+A$1599)", "Boiby Pro Display XDR (32-inch 6K) (+A$4999)"]
      };

      let selectedModel = null;
      let selectedOptions = {};

      const $ = q => document.querySelector(q);
      const $$ = q => Array.from(document.querySelectorAll(q));
      const cleanLabel = opt => (opt||'').split("(")[0].trim();
      const priceDelta = opt => {
        if (!opt) return 0;
        const m = opt.match(/\+A\$(\d+)/);
        return m ? parseInt(m[1],10) : 0;
      };
      const formatPrice = n => `A$${n.toLocaleString('en-AU')}`;

      // Memory guide content for different models
      const memoryGuides = {
        'B5': `
          <p><strong>How much memory is right for you?</strong></p>
          <p>Our unified memory architecture allows the CPU and GPU to access the same memory pool, improving performance and efficiency. Here is a general guide to how much you might need:</p>
          
          <p><strong>16 GB:</strong> Good for general users, students, and users with standard workloads. This configuration is ideal for those who primarily browse the web, stream content, use productivity apps, do light video and photo editing, and perform multitasking</p>
          
          <p><strong>24 GB:</strong> Good for users who need slightly more headroom for multitasking and moderate creative work. Ideal for those who do light to moderate video editing, gaming, graphic design, or programming, but don't push those to the extreme. Good for users who run multiple intensive apps simultaneously and perform more multitasking.</p>
          
          <p><strong>32 GB:</strong> Best for users engaging in more intensive workflows, such as video editing in 4K, music production with multiple tracks, large-scale coding projects, working with 3D models, playing memory-intensive simulator games, or using virtual machines.</p>
        `,
        'B5 Pro': `
          <p><strong>How much memory is right for you?</strong></p>
          <p>Our unified memory architecture allows the CPU and GPU to access the same memory pool, improving performance and efficiency. Here is a general guide to how much you might need:</p>
          
          <p><strong>24 GB:</strong> Good for users with standard or relatively intensive workflows, good for multitasking with multiple apps, productivity, and moderate creative work. Ideal for those who do light to moderate video editing, gaming, graphic design, or programming, but don't push those to the extreme.</p>
          
          <p><strong>48 GB:</strong> Ideal for power users and creative professionals, such as those working with large and highly complex 3D models, editing multi-layer 8K video, or handling complex simulations and data analysis. This memory amount should handle running multiple virtual machines or advanced software development environments.</p>
          
          <p><strong>64 GB:</strong> For professionals in specialized fields like high-budget film editing, data science, engineering, or machine learning. Designed for workflows that involve enormous projects and require huge amounts of data to be kept in active memory.</p>
        `
      };

      function findGroupByName(name) {
        const groups = $$('#options .group');
        return groups.find(g => g.querySelector('h3') && g.querySelector('h3').innerText.toLowerCase() === name.toLowerCase());
      }

      function renderModels() {
        const container = $('#models');
        if (!container) return;
        container.innerHTML = '';
        const configs = baseConfigs;
        Object.keys(configs).forEach(model => {
          const cfg = configs[model];
          const card = document.createElement('div');
          card.className = 'card';
          card.setAttribute('data-model', model);
          
          // Create image element
          const imageUrl = `BoibyMini${selectedColor}.png`;
          
          card.innerHTML = `
            <div class="card-content">
              <div class="card-image">
                <img src="${imageUrl}" alt="${model} ${selectedColor}" id="card-image-${model.replace(/\s+/g, '-')}">
              </div>
              <div class="card-details">
                <h2>Boiby Mini - ${model}</h2>
                <p class="price">From ${formatPrice(cfg.price)}</p>
                <ul>
                  <li>${cleanLabel(cfg.upgrades.chip[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.memory[0])}</li>
                  <li>${cleanLabel(cfg.upgrades.storage[0])}</li>
                  ${model === 'B5' ? '<li>' + cleanLabel(cfg.upgrades.ethernet[0]) + '</li>' : ''}
                </ul>
                <p><strong>Ports:</strong></p>
                <ul>
                  ${cfg.ports.map(port => `<li>${port}</li>`).join('')}
                </ul>
              </div>
            </div>
            <div class="color-display">
              Color: ${selectedColor}
            </div>
            <button class="select-btn" data-model="${model}">Select</button>
          `;
          
          // Add select button event
          card.querySelector('.select-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const model = e.target.getAttribute('data-model');
            selectedModel = model;
            selectedColor = 'Silver';
            
            const modelsEl = $('#models');
            if (modelsEl) modelsEl.style.display = 'none';
            $('#configurator').style.display = 'block';
            showConfigurator();
          });
          
          container.appendChild(card);
        });
      }

      function showConfigurator() {
        const cfg = baseConfigs[selectedModel];
        const optionsDiv = $('#options');
        optionsDiv.innerHTML = '';
        selectedOptions = {};

        $('#heroTitle').innerText = `Customise your Boiby Mini — ${selectedModel}`;
        
        // Update hero image
        const heroImage = $('#heroImage');
        heroImage.innerHTML = `<img src="BoibyMini${selectedColor}.png" alt="${selectedModel} ${selectedColor}">`;

        // upgrades
        Object.keys(cfg.upgrades).forEach(category => {
          const group = document.createElement('div');
          group.className = 'group';
          const h3 = document.createElement('h3');
          
          // Add info icon for memory category
          if (category === 'memory') {
            h3.innerHTML = `Memory <span class="info-icon" data-category="memory">?</span>`;
          } else {
            h3.innerText = category.charAt(0).toUpperCase() + category.slice(1);
          }
          
          group.appendChild(h3);

          cfg.upgrades[category].forEach((opt, idx) => {
            const pill = document.createElement('div');
            pill.className = 'pill';
            pill.dataset.cat = category;
            pill.dataset.value = opt; // IMPORTANT: canonical full string
            pill.innerHTML = `<span class="label">${cleanLabel(opt)}</span><span class="price-right">${priceDelta(opt) ? ('+A$' + priceDelta(opt)) : ''}</span>`;

            pill.addEventListener('click', () => {
              if (pill.classList.contains('disabled')) return;
              if (category === 'addons') {
                pill.classList.toggle('selected');
                if (!selectedOptions.addons) selectedOptions.addons = [];
                const full = pill.dataset.value;
                if (pill.classList.contains('selected')) selectedOptions.addons.push(full);
                else selectedOptions.addons = selectedOptions.addons.filter(a => a !== full);
              } else {
                // single-select logic
                Array.from(group.querySelectorAll('.pill')).forEach(s => s.classList.remove('selected'));
                pill.classList.add('selected');
                selectedOptions[category] = pill.dataset.value;
                if (category === 'chip') handleDependencies(); // re-evaluate when chip changes
              }
              renderHeroSummary();
              updatePrice();
            });

            // Default selection logic
            if (idx === 0) {
              pill.classList.add('selected');
              selectedOptions[category] = pill.dataset.value;
            }

            group.appendChild(pill);
          });

          if (category === 'memory') {
            const note = document.createElement('div');
            note.className = 'note';
            note.innerText = 'Higher memory options require higher-end CPU/GPU selections.';
            group.appendChild(note);
            
            // Add event listener to the info icon
            const infoIcon = h3.querySelector('.info-icon');
            if (infoIcon) {
              infoIcon.addEventListener('click', () => showMemoryModal(selectedModel));
            }
          }

          optionsDiv.appendChild(group);
        });

        // add-ons group
        const addonsGroup = document.createElement('div');
        addonsGroup.className = 'group';
        const addonsTitle = document.createElement('h3');
        addonsTitle.innerText = 'Add-ons';
        addonsGroup.appendChild(addonsTitle);
        Object.keys(addons).forEach(sub => {
          const subTitle = document.createElement('div');
          subTitle.style.fontWeight = '600';
          subTitle.style.marginTop = '8px';
          subTitle.innerText = sub.charAt(0).toUpperCase() + sub.slice(1);
          addonsGroup.appendChild(subTitle);
          addons[sub].forEach(opt => {
            const pill = document.createElement('div');
            pill.className = 'pill';
            pill.dataset.cat = 'addons';
            pill.dataset.value = opt;
            pill.innerHTML = `<span class="label">${cleanLabel(opt)}</span><span class="price-right">${priceDelta(opt) ? ('+A$' + priceDelta(opt)) : ''}</span>`;
            pill.addEventListener('click', () => {
              pill.classList.toggle('selected');
              if (!selectedOptions.addons) selectedOptions.addons = [];
              const full = pill.dataset.value;
              if (pill.classList.contains('selected')) selectedOptions.addons.push(full);
              else selectedOptions.addons = selectedOptions.addons.filter(a => a !== full);
              renderHeroSummary();
              updatePrice();
            });
            addonsGroup.appendChild(pill);
          });
        });
        optionsDiv.appendChild(addonsGroup);

        // apply dependency logic (this will enable/disable and keep selections consistent)
        handleDependencies();
        renderHeroSummary();
        updatePrice();
      }

      function showMemoryModal(model) {
        const modal = $('#memoryModal');
        const title = $('#memoryModalTitle');
        const content = $('#memoryModalContent');
        
        // Set title and content based on model
        title.textContent = `${model} Memory Guide`;
        content.innerHTML = memoryGuides[model] || memoryGuides['B5'];
        
        modal.classList.add('visible');
        
        // Add event listener to close button
        const closeButton = modal.querySelector('.modal-close');
        closeButton.addEventListener('click', hideMemoryModal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            hideMemoryModal();
          }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            hideMemoryModal();
            document.removeEventListener('keydown', escHandler);
          }
        });
      }
      
      function showChipModal() {
        const modal = $('#chipModal');
        modal.classList.add('visible');
        
        // Add event listener to close button
        const closeButton = modal.querySelector('.modal-close');
        closeButton.addEventListener('click', hideChipModal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            hideChipModal();
          }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape') {
            hideChipModal();
            document.removeEventListener('keydown', escHandler);
          }
        });
      }
      
      function hideMemoryModal() {
        const modal = $('#memoryModal');
        modal.classList.remove('visible');
      }
      
      function hideChipModal() {
        const modal = $('#chipModal');
        modal.classList.remove('visible');
      }

      function handleDependencies() {
        if (!selectedModel) return;
        const cfg = baseConfigs[selectedModel];
        const optionsDiv = $('#options');
        if (!optionsDiv) return;

        // canonical chip string (ensure we have one)
        const chipFull = selectedOptions.chip || cfg.upgrades.chip[0];

        // MEMORY
        const memoryGroup = findGroupByName('memory');
        if (memoryGroup) {
          const memPills = Array.from(memoryGroup.querySelectorAll('.pill'));
          memPills.forEach(p => p.classList.remove('disabled'));

          if (selectedModel === 'B5 Pro') {
            // Only enable 64GB if the upgraded chip (14-core) is selected
            const hasUpgradedChip = chipFull.includes('14-core CPU');
            memPills.forEach(p => {
              if (p.dataset.value.includes('64 GB')) {
                p.classList.toggle('disabled', !hasUpgradedChip);
              }
            });
          }

          // if selected memory is disabled, pick first valid
          if (selectedOptions.memory) {
            const cur = memPills.find(p => p.dataset.value === selectedOptions.memory);
            if (cur && cur.classList.contains('disabled')) {
              memPills.forEach(p => p.classList.remove('selected'));
              const firstValid = memPills.find(p => !p.classList.contains('disabled'));
              if (firstValid) {
                firstValid.classList.add('selected');
                selectedOptions.memory = firstValid.dataset.value;
              } else {
                delete selectedOptions.memory;
              }
            }
          }
          // sync UI selected pill with selectedOptions.memory
          if (selectedOptions.memory) {
            memPills.forEach(p => p.classList.toggle('selected', p.dataset.value === selectedOptions.memory));
          }
        }

        // CHIP: ensure chip selection exists and UI is synced (use dataset.value comparisons)
        const chipGroup = findGroupByName('chip');
        if (chipGroup) {
          const chipPills = Array.from(chipGroup.querySelectorAll('.pill'));
          if (!selectedOptions.chip) {
            const sel = chipPills.find(p => p.classList.contains('selected')) || chipPills[0];
            if (sel) {
              sel.classList.add('selected');
              selectedOptions.chip = sel.dataset.value;
            }
          } else {
            chipPills.forEach(p => p.classList.toggle('selected', p.dataset.value === selectedOptions.chip));
          }
        }
      }

      function renderHeroSummary() {
        const list = $('#heroList');
        if (!list) return;
        list.innerHTML = '';
        const cfg = baseConfigs[selectedModel];
        list.appendChild(li(`Boiby Mini — ${selectedModel}`));
        list.appendChild(li(`Color: ${selectedColor}`));
        
        // Add ports information
        list.appendChild(li("Ports:"));
        cfg.ports.forEach(port => {
          list.appendChild(li(`• ${port}`));
        });
        
        const order = ['chip','memory','storage','ethernet'];
        order.forEach(cat => {
          if (selectedOptions[cat]) list.appendChild(li(cleanLabel(selectedOptions[cat])));
        });
        if (selectedOptions.addons && selectedOptions.addons.length) {
          selectedOptions.addons.forEach(a => list.appendChild(li(cleanLabel(a))));
        }
      }

      function updatePrice() {
        const cfg = baseConfigs[selectedModel];
        let price = cfg.price;
        Object.keys(selectedOptions).forEach(cat => {
          if (cat === 'addons') {
            selectedOptions.addons.forEach(a => price += priceDelta(a));
          } else {
            price += priceDelta(selectedOptions[cat]);
          }
        });
        $('#finalPrice').innerText = `Total: ${formatPrice(price)}`;
      }

      function showConfirmation() {
        const cfg = baseConfigs[selectedModel];
        let price = cfg.price;
        
        // Hide configurator and checkout, show confirmation
        $('#configurator').style.display = 'none';
        $('#checkout').style.display = 'none';
        $('#confirmation').style.display = 'block';
        
        // Set confirmation image
        $('#confirmationImage').innerHTML = `<img src="BoibyMini${selectedColor}.png" alt="${selectedModel} ${selectedColor}">`;
        
        // Set confirmation model text
        $('#confirmationModel').textContent = `Boiby Mini ${selectedModel} - ${selectedColor}`;
        
        // Build confirmation list
        const list = $('#confirmationList');
        list.innerHTML = '';
        
        list.appendChild(li(`Model: Boiby Mini ${selectedModel}`));
        list.appendChild(li(`Color: ${selectedColor}`));
        list.appendChild(li(cleanLabel(selectedOptions.chip || cfg.upgrades.chip[0])));
        list.appendChild(li(cleanLabel(selectedOptions.memory || cfg.upgrades.memory[0])));
        list.appendChild(li(cleanLabel(selectedOptions.storage || cfg.upgrades.storage[0])));
        
        if (selectedModel === 'B5') {
          list.appendChild(li(cleanLabel(selectedOptions.ethernet || cfg.upgrades.ethernet[0])));
        }
        
        if (selectedOptions.addons && selectedOptions.addons.length) {
          selectedOptions.addons.forEach(a => list.appendChild(li(cleanLabel(a))));
        }
        
        // Calculate final price
        Object.keys(selectedOptions).forEach(cat => {
          if (cat === 'addons') {
            selectedOptions.addons.forEach(a => price += priceDelta(a));
          } else {
            price += priceDelta(selectedOptions[cat]);
          }
        });
        
        $('#confirmationTotal').textContent = `Total: ${formatPrice(price)}`;
      }

      function li(text) { 
        const el = document.createElement('li'); 
        el.textContent = text; 
        return el; 
      }

      const backBtn = $('#backBtn');
      if (backBtn) backBtn.addEventListener('click', () => {
        $('#configurator').style.display = 'none';
        $('#models').style.display = 'grid';
      });

      const confirmationBackBtn = $('#confirmationBackBtn');
      if (confirmationBackBtn) confirmationBackBtn.addEventListener('click', () => {
        $('#confirmation').style.display = 'none';
        $('#models').style.display = 'grid';
        $('#checkout').style.display = 'flex';
      });

      const addToBagBtn = $('#addToBagBtn');
      if (addToBagBtn) addToBagBtn.addEventListener('click', showConfirmation);
      
      const chipInfoLink = $('#chipInfoLink');
      if (chipInfoLink) chipInfoLink.addEventListener('click', showChipModal);

      document.addEventListener('DOMContentLoaded', () => {
        renderModels();
      });

      window.__boiby_reloadModels = renderModels;
    })();
  </script>
</body>
</html>
